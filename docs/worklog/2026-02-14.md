# Worklog - 2026-02-14

## 목표
- CI에서 `functions-e2e-once`의 flake/실패(`status != packaged`) 원인 제거
- 내부 링크 MVP 추가(규칙 기반, LLM/embedding 없이)
- Firestore indexes 배포 경로(SSOT) 정리 + 안전 배포
- `firebase-functions` outdated 경고 제거 + 운영 반영

## 오늘 완료된 작업

### 1) E2E 안정화 (packaged까지 도달 보장)
- 원인: inline 실행에서 task payload object spread로 불필요한 `keywordId`가 섞이며 `idempotencyKey` 검증이 과도하게 실패하는 케이스 존재
- 조치:
  - `functions/src/lib/tasks.ts`
    - `assertIdempotencyKey()`를 **taskType별 필수 id만 강제**하도록 변경 (keywordId/articleId)
  - `functions/src/handlers/tasks/articleQaFix.ts`
    - `article_qa_fix`가 이미 `pass` 상태를 관측해도 파이프라인이 계속 진행되도록 `article_qa` 재-enqueue(정식 플로우로 복귀)
- 로컬 검증:
  - Firestore emulator에서 `npm run e2e:check:timeout --prefix functions` 여러 차례 `E2E_OK`, `status=packaged` 확인
  - 주의: preflight가 `TASK_SECRET`을 요구하므로 로컬 실행 시 `TASK_SECRET=ci-secret`(또는 적절한 값) 필요

### 2) 내부 링크 MVP
- 요구: 새 글 생성/패키징 시점에 내부 링크(3~4개) 자동 선택/저장
- 구현:
  - `functions/src/lib/internalLinks.ts`
    - 우선순위: 동일 `clusterId` > `hashtags12` overlap > 최신성
    - 결과 저장: `articles/{id}.internalLinks[]` (+ `internalLinksPickedAt`)
  - `functions/src/handlers/tasks/articlePackage.ts`
    - `status=packaged` 기록 후 best-effort로 internalLinks 계산/저장 (실패해도 패키징은 진행)
  - `functions/src/handlers/tasks/bodyGenerate.ts`
    - 템플릿에 hook 주석 추가: `<!-- INTERNAL_LINKS_HOOK: ... -->`
  - 인덱스:
    - 내부 링크 후보 조회 쿼리용 인덱스 추가: `articles(siteId, status, createdAt)`
  - 테스트:
    - `functions/tests/lib/internalLinks.test.ts` (우선순위 정렬 규칙)

### 3) Firestore indexes 배포 경로(SSOT) 정리
- 문제:
  - `firebase.json`이 `infra/firestore.indexes.datastore.json`(빈 파일)을 참조하고 있어 `firebase deploy --only firestore:indexes`가 위험
- 조치:
  - `firebase.json`의 `firestore.indexes`를 `infra/firestore.indexes.json`로 변경하여 SSOT 고정
- 결과:
  - `firebase deploy --project blog --only firestore:indexes`가 `infra/firestore.indexes.json`을 읽어 정상 배포되는 상태로 정리

### 4) firebase-functions 업그레이드 + 운영 반영
- 조치:
  - `functions/package.json`
    - `firebase-functions`를 권장 버전대로 업그레이드 (outdated 경고 제거 목적)
    - `firebase-admin`도 호환 버전으로 업그레이드
- 로컬 검증:
  - `npm run build --prefix functions` 통과
  - `npm --prefix functions test` 통과
  - Firestore emulator `e2e:check:timeout` 통과
- 운영 반영:
  - `firebase deploy --project blog --only functions` 재배포 완료 (업그레이드 반영)

## 운영 배포 기록
- Functions 배포(2회):
  - `firebase deploy --project blog --only functions`
- Firestore indexes 배포(1회, SSOT 변경 후):
  - `firebase deploy --project blog --only firestore:indexes`

## 남은 이슈 / 다음 작업
- Node 엔진 정책 정리:
  - `functions/package.json`은 `engines.node=22`인데 로컬/CI에서 Node 20을 쓰면 `npm install` 시 `EBADENGINE` 경고 발생 가능
  - 권장: CI/로컬 Node 22 고정 + (가능하면) `.nvmrc` 또는 volta 핀 추가 + 워크플로우 `setup-node` 정리

