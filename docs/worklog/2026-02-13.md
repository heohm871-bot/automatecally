# Worklog - 2026-02-13

## 오늘 완료된 작업
- status/lifecycle 모델 분리 결정을 코드로 반영하고 단독 커밋/브랜치로 분리
  - `status`: 파이프라인 진행(queued/generating/ready/packaged/published/failed...)
  - `lifecycle`: 거버넌스(draft/staged/promoted/archived...)
- A/B 변경 분리 운영
  - A(정책/모델 핵심 변경)만 단독 PR로 올릴 수 있게 분리
  - B(부수 변경)도 별도 브랜치에서 안전하게 분해 후, 작업 브랜치로 cherry-pick

## A (정책/모델) 단독 PR 준비
- 브랜치: `feat/lifecycle-status-split`
- 커밋(메시지 정리 포함): `e7c21ea` `feat: split article status and lifecycle`
  - create 시 `lifecycle=draft` 기본값(없을 때만)
  - promote는 `lifecycle=promoted`로 유지 + prod 가드레일 추가(>= packaged/published)
  - articles UI에서 status와 lifecycle을 분리 표기(배지)
- 원격 push 완료 (PR 생성 가능):
  - `https://github.com/heohm871-bot/automatecally/pull/new/feat/lifecycle-status-split`

## B (부수 변경) 분해/복구
- 접근 방식
  - stash 내용은 먼저 `git stash show`로 확인(작업트리 오염 방지)
  - stash 베이스 커밋에서 `chore/inspect-stash-b` 브랜치를 만들고 거기서 apply
  - 성격별로 커밋 쪼갠 뒤 작업 브랜치로 cherry-pick
- 작업 브랜치 누적 커밋(요약):
  - `6fcfde4` `feat(web): add admin settings page`
  - `19b3505` `chore(web): support firebase emulators`
  - `d833758` `feat(sites): add seed keywords`
  - `fd6bbf1` `feat(pipeline): respect site enable and daily target`
  - `4cf0a3e` `feat(pipeline): enforce prod runTag policy and retries`
  - `7d7be0b` `feat(publish): schedule windows and runTag package paths`
  - `07d741a` `feat(keywords): collect candidates and propagate runTag`
  - `d3bf6e7` `feat(qa): flag emoji and markdown bold`
  - `4e2434e` `chore(infra): add rules manager scripts`
  - `cfd1844` `test(publish): add schedule window tests`
  - `828a999` `chore(ops): add package promote scripts`

## 테스트/빌드 결과
- `functions/`: `npm test` 통과 (14/14)
- `apps/web/`: `npm run build` 통과

## 추가 반영(운영 안전장치)
- `scripts/native-cutover-check.sh`가 deploy 전에 `INFRA_ENV=prod`로 `rules:sync` / `indexes:sync`를 선실행하도록 보강
  - 목적: dev/staging용(상대적으로 permissive한) rules/indexes가 base 템플릿에 남아있는 상태로 prod에 배포되는 실수 방지

## 리스크/주의
- `infra/firestore.rules`가 `request.auth != null`이면 전체 read/write 허용으로 바뀜
  - 의도된 정책인지(특히 prod) 확인 필요
- `stash@{0}`가 아직 남아 있음
  - A/B 커밋 복구가 끝났으면 drop 후보

## 다음에 할 작업
1. A 단독 PR 생성 및 머지까지 처리
   - 리뷰가 시작되기 전에 commit message는 이미 정리 완료(`e7c21ea`)
2. B는 A 머지 이후에 별도 PR로 올릴지, 커밋 더 쪼갤지 결정
   - 특히 `infra/firestore.rules` 변경은 별도 PR/커밋으로 분리 고려
3. `stash@{0}` 처리
   - 필요 없으면 `git stash drop stash@{0}`

---

## 추가 진행 (B 브랜치: 예약발행 실행기 + CI/E2E 안정화)

### 반영한 기능
- 예약발행 실행 태스크 추가: `publish_execute`
  - `article_package`에서 `publishPlan.scheduledAt`에 맞춰 Cloud Tasks로 스케줄 enqueue
  - `publishMode=manual`이면 실행 스킵(콘솔 수동 트리거용)
- Tistory 발행 연동(초기)
  - `TISTORY_ACCESS_TOKEN` + `sites/{siteId}.tistory.blogName` 기반으로 `post/write` 호출
  - E2E/inline에서는 외부 발행 자체를 스킵(`E2E_SKIP_PUBLISH=1`)

### 운영 안정화
- idempotencyKey 최소 강제(구조/포맷 검증) + 주요 태스크 키에 runDate 포함
- retry는 KST 기준 runDate mismatch면 스킵(자정 경계 방지)
- inline retry 데드락 방지: lock 키를 retryCount 포함 형태로 변경

### CI/E2E
- e2e workflow에서 `TASK_SECRET`/`E2E_SKIP_PUBLISH` 명시
- 실패 시 dump 강화: articles/taskFailures 포함 + site filter
- E2E에서 `packaged`까지 짧게 폴링(최대 10초 기본)

### 남은 이슈
- `functions-e2e-once`가 여전히 `status != packaged`로 실패하는 케이스 존재
  - 다음 액션: artifacts의 `functions-e2e-log`에서 `E2E_TASK_FAILED`(taskRuns 실패) 또는 dump(`taskFailures.json`, `articles.json`)로 원인 확정 후 수정
