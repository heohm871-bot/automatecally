name: ops-deploy-blog

on:
  workflow_dispatch:
    inputs:
      deploy_functions:
        description: "Deploy Cloud Functions"
        required: true
        type: boolean
        default: true
      deploy_indexes:
        description: "Deploy Firestore indexes"
        required: true
        type: boolean
        default: true

jobs:
  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install deps
        run: npm ci
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy (Functions)
        run: firebase deploy --project blog-native-260212 --only functions --token "$FIREBASE_TOKEN"
      
      - name: Assert deploy secrets
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${FIREBASE_TOKEN}" ]; then
            echo "Missing secrets.FIREBASE_TOKEN (required to run firebase deploy in CI)."
            exit 1
          fi

      - name: Assert post-deploy smoke secrets
        env:
          OPS_SECRET: ${{ secrets.OPS_SECRET }}
          OPS_SMOKE_SITE_ID: ${{ secrets.OPS_SMOKE_SITE_ID }}
          OPS_WEB_BASE_URL: ${{ secrets.OPS_WEB_BASE_URL }}
          OPS_WEB_HEALTH_TOKEN: ${{ secrets.OPS_WEB_HEALTH_TOKEN }}
        run: |
          set -euo pipefail
          missing=0
          if [ -z "${OPS_SECRET}" ]; then
            echo "Missing secrets.OPS_SECRET (must equal Firebase Functions TASK_SECRET; used for X-Ops-Secret)."
            missing=1
          fi
          if [ -z "${OPS_SMOKE_SITE_ID}" ]; then
            echo "Missing secrets.OPS_SMOKE_SITE_ID (safe siteId for ops smoke)."
            missing=1
          fi
          if [ -z "${OPS_WEB_BASE_URL}" ]; then
            echo "Missing secrets.OPS_WEB_BASE_URL (e.g. https://<your-vercel-domain>)."
            missing=1
          fi
          if [ -z "${OPS_WEB_HEALTH_TOKEN}" ]; then
            echo "Missing secrets.OPS_WEB_HEALTH_TOKEN (must equal web runtime OPS_HEALTH_TOKEN; used for Authorization Bearer)."
            missing=1
          fi
          if [ "$missing" -ne 0 ]; then
            echo "Post-deploy smoke will fail without the above secrets. Configure them in GitHub -> Settings -> Secrets and variables -> Actions."
            exit 1
          fi

      - name: Deploy (Functions)
        if: inputs.deploy_functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: firebase deploy --project blog --only functions --token "$FIREBASE_TOKEN"

      - name: Deploy (Firestore indexes)
        if: inputs.deploy_indexes
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: firebase deploy --project blog --only firestore:indexes --token "$FIREBASE_TOKEN"

      - name: Post-deploy smoke (prod)
        env:
          OPS_FIREBASE_PROJECT_ID: blog-native-260212
          OPS_FUNCTIONS_REGION: us-central1
          OPS_SECRET: ${{ secrets.OPS_SECRET }}
          OPS_SMOKE_SITE_ID: ${{ secrets.OPS_SMOKE_SITE_ID }}
          OPS_WEB_BASE_URL: ${{ secrets.OPS_WEB_BASE_URL }}
          OPS_WEB_HEALTH_TOKEN: ${{ secrets.OPS_WEB_HEALTH_TOKEN }}
        run: bash scripts/ops/post-deploy-smoke.sh
